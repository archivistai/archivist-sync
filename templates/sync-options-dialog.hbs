<form class="archivist-sync-content" autocomplete="off">
  <style>
    /* ===== Color Tokens (light/dark aware) ===== */
    .archivist-sync-content {
      --arch-bg: rgba(24, 27, 32, 0.96);
      --arch-bg-alt: rgba(255, 255, 255, 0.04);
      --arch-panel: rgba(255, 255, 255, 0.03);
      --arch-border: rgba(255, 255, 255, 0.12);
      --arch-border-soft: rgba(255, 255, 255, 0.08);
      --arch-text: #e8e8e8;
      --arch-text-muted: #b9b9b9;
      --arch-shadow: rgba(0, 0, 0, 0.35);
      --arch-accent-pull: #3ea8ff;
      /* pull = download */
      --arch-accent-push: #47d16a;
      /* push = upload  */
      --arch-accent-warn: #ffb020;
    }

    /* Prefer light scheme */
    @media (prefers-color-scheme: light) {
      .archivist-sync-content {
        --arch-bg: #f7f8fa;
        --arch-bg-alt: #fff;
        --arch-panel: #fff;
        --arch-border: rgba(0, 0, 0, 0.12);
        --arch-border-soft: rgba(0, 0, 0, 0.08);
        --arch-text: #1c1f24;
        --arch-text-muted: #4b5563;
        --arch-shadow: rgba(0, 0, 0, 0.08);
        --arch-accent-pull: #0b6bcb;
        --arch-accent-push: #0d8a3c;
        --arch-accent-warn: #b77400;
      }
    }

    /* Optional explicit theme hooks some Foundry themes use */
    body.light .archivist-sync-content,
    body.theme-light .archivist-sync-content {
      --arch-bg: #f7f8fa;
      --arch-bg-alt: #fff;
      --arch-panel: #fff;
      --arch-border: rgba(0, 0, 0, 0.12);
      --arch-border-soft: rgba(0, 0, 0, 0.08);
      --arch-text: #1c1f24;
      --arch-text-muted: #4b5563;
      --arch-shadow: rgba(0, 0, 0, 0.08);
      --arch-accent-pull: #0b6bcb;
      --arch-accent-push: #0d8a3c;
      --arch-accent-warn: #b77400;
    }

    /* ===== Archivist Sync — Dialog Polish (scoped) ===== */
    .archivist-sync-dialog .window-content {
      padding: 0;
    }

    .archivist-sync-content {
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .archivist-sync-content .tabs {
      display: grid;
      grid-auto-flow: column;
      gap: 6px;
      align-items: center;
      justify-content: start;
    }

    .archivist-sync-content .tabs .item {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--arch-border);
      background: var(--arch-bg-alt);
      text-decoration: none;
      color: var(--arch-text);
      font-weight: 600;
      letter-spacing: .2px;
    }

    .archivist-sync-content .tabs .item.active {
      background: var(--color-primary-50, rgba(0, 0, 0, 0.18));
      border-color: var(--color-primary-60, rgba(255, 255, 255, 0.22));
      box-shadow: 0 0 0 1px var(--arch-border) inset;
      color: var(--arch-text);
    }

    .archivist-sync-content .tab-content {
      border-top: 1px solid var(--arch-border);
      padding-top: 10px;
    }

    .archivist-sync-content .tab {
      display: none;
    }

    .archivist-sync-content .tab.active {
      display: block;
    }

    .section-header {
      position: sticky;
      top: 0;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      background: var(--arch-bg-alt);
      border: 1px solid var(--arch-border);
      border-radius: 8px;
    }

    .section-header h4 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--arch-text);
    }

    .section-header .actions {
      display: inline-flex;
      gap: 8px;
    }

    .world-details-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
    }

    .world-section {
      border: 1px solid var(--arch-border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--arch-panel);
    }

    .world-data-box {
      padding: 12px;
      display: grid;
      gap: 8px;
      max-height: 600px;
      overflow: auto;
    }

    .world-field {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 8px;
      align-items: center;
      min-height: 32px;
    }

    .world-field label {
      color: var(--arch-text-muted);
      font-weight: 600;
    }

    .world-field .field-value {
      color: var(--arch-text);
      word-break: break-word;
    }

    .world-field .description-field {
      max-height: 200px;
      overflow: auto;
      padding: 8px;
      border: 1px dashed var(--arch-border);
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.04);
    }

    .sync-controls {
      padding: 10px 12px;
      border-top: 1px solid var(--arch-border);
      background: var(--arch-panel);
      display: flex;
      justify-content: flex-end;
    }

    .characters-section,
    .entities-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 560px;
    }

    .character-type-section h4,
    .entities-section h4 {
      margin: 0 0 6px 0;
      font-size: 13px;
      letter-spacing: .3px;
      color: var(--arch-text);
    }

    .actors-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 8px;
    }

    .actor-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border: 1px solid var(--arch-border);
      border-radius: 8px;
      background: var(--arch-panel);
    }

    .actor-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .actor-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .actor-details h5 {
      margin: 0;
      font-size: 13px;
      color: var(--arch-text);
    }

    .actor-type {
      margin: 0;
      font-size: 11px;
      color: var(--arch-text-muted);
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    .actor-actions button {
      padding: 4px 8px;
      border-radius: 6px;
    }

    .entity-list {
      margin: 0;
      padding: 0;
      list-style: none;
      border: 1px solid var(--arch-border);
      border-radius: 8px;
      overflow: auto;
      max-height: 520px;
      background: var(--arch-panel);
    }

    .entity-list li {
      padding: 8px 12px;
      border-bottom: 1px solid var(--arch-border-soft);
      color: var(--arch-text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .entity-actions {
      margin-left: auto;
      display: inline-flex;
      gap: 6px;
    }

    .entity-actions .btn {
      padding: 4px 8px;
    }

    .entity-thumb {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      object-fit: cover;
      flex: 0 0 28px;
    }

    .entity-list li:last-child {
      border-bottom: none;
    }

    .no-actors,
    .no-entities,
    .no-actors-hint,
    .warning-message p {
      color: var(--arch-text-muted);
    }

    .warning-message {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border: 1px solid var(--arch-border);
      border-radius: 8px;
      background: var(--arch-panel);
    }

    .current-selection,
    .sync-info {
      border: 1px solid var(--arch-border);
      border-radius: 8px;
      padding: 10px 12px;
      background: var(--arch-panel);
    }

    .api-status {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group {
      display: grid;
      gap: 6px;
    }

    .input-row {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 8px;
      align-items: center;
      min-height: 32px;
    }

    .ai-instruction {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    select,
    button {
      color: var(--arch-text);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--arch-border);
      background: var(--arch-panel);
      color: var(--arch-text);
      cursor: pointer;
      transition: transform .04s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 1px 0 var(--arch-border-soft);
    }

    .btn:hover {
      background: var(--arch-bg-alt);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn[disabled] {
      opacity: .55;
      cursor: default;
      transform: none;
    }

    .btn.pull {
      border-color: color-mix(in srgb, var(--arch-accent-pull), var(--arch-border) 60%);
    }

    .btn.pull:hover {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--arch-accent-pull), transparent 70%);
    }

    .btn.pull i {
      color: var(--arch-accent-pull);
    }

    .btn.push {
      border-color: color-mix(in srgb, var(--arch-accent-push), var(--arch-border) 60%);
    }

    .btn.push:hover {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--arch-accent-push), transparent 70%);
    }

    .btn.push i {
      color: var(--arch-accent-push);
    }

    .btn.warn i {
      color: var(--arch-accent-warn);
    }

    /* Panels & lists */
    .section-header {
      background: var(--arch-bg-alt);
      border: 1px solid var(--arch-border);
    }

    .world-section {
      background: var(--arch-panel);
      border-color: var(--arch-border);
      box-shadow: 0 2px 8px var(--arch-shadow);
    }

    .entity-list {
      background: var(--arch-panel);
      border-color: var(--arch-border);
    }

    .entity-list li:hover {
      background: var(--arch-bg-alt);
    }

    .character-type-section h4,
    .section-header h4 i {
      opacity: .9;
      margin-right: 4px;
    }

    /* ===== Importer Preview — Height & Robust Controls ===== */
    .archivist-sync-content .tab[data-tab="importer"] .entities-section {
      max-height: none;
    }

    .archivist-sync-content .importer-preview {
      min-height: 520px;
      display: flex;
      flex-direction: column;
    }

    .archivist-sync-content .importer-preview .world-data-box {
      flex: 1;
      max-height: none;
      height: 72vh;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .archivist-sync-content .importer-preview-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .archivist-sync-content .importer-preview-table th,
    .archivist-sync-content .importer-preview-table td {
      padding: 6px 8px;
      vertical-align: top;
      word-wrap: break-word;
    }

    /* Column sizing: Include (tight), Name (grow), Type (compact), Confidence (compact), Fields (largest) */
    .archivist-sync-content .importer-preview-table th:nth-child(1),
    .archivist-sync-content .importer-preview-table td:nth-child(1) {
      width: 54px;
      text-align: center;
      white-space: nowrap;
    }

    .archivist-sync-content .importer-preview-table th:nth-child(2),
    .archivist-sync-content .importer-preview-table td:nth-child(2) {
      width: 150px;
      word-break: break-word;
    }

    .archivist-sync-content .importer-preview-table th:nth-child(3),
    .archivist-sync-content .importer-preview-table td:nth-child(3) {
      width: 100px;
      white-space: nowrap;
    }

    .archivist-sync-content .importer-preview-table th:nth-child(4),
    .archivist-sync-content .importer-preview-table td:nth-child(4) {
      width: 100px;
      white-space: nowrap;
    }

    .archivist-sync-content .importer-preview-table th:nth-child(5),
    .archivist-sync-content .importer-preview-table td:nth-child(5) {
      width: auto;
    }

    .archivist-sync-content .preview-bucket {
      padding: 8px;
      border: 1px solid var(--arch-border);
      border-radius: 8px;
      background: var(--arch-panel);
      overflow: hidden;
    }

    /* Control sizing and resilience */
    .archivist-sync-content .btn,
    .archivist-sync-content button,
    .archivist-sync-content select,
    .archivist-sync-content input[type="number"],
    .archivist-sync-content textarea {
      min-height: 36px;
    }

    .archivist-sync-content .btn {
      min-width: 44px;
    }

    .archivist-sync-content select {
      min-width: 160px;
    }

    .archivist-sync-content .importer-field-select {
      min-width: 140px;
      width: 100%;
    }

    .archivist-sync-content .importer-type-select {
      min-width: 80px;
    }

    .archivist-sync-content .input-row>label {
      min-height: 32px;
      display: flex;
      align-items: center;
    }

    /* Loading spinner */
    .tab-loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 16px;
      color: var(--arch-text-muted);
    }

    .tab-loading-spinner i {
      font-size: 32px;
      color: var(--arch-accent-pull);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .tab-loading-spinner p {
      margin: 0;
      font-size: 14px;
    }
  </style>
  <!-- Tab Navigation -->
  <nav class="tabs" data-group="main">
    {{#if showSetupMode}}
    <!-- World Setup Mode - Only show setup option -->
    <a class="item active" data-tab="setup">
      <i class="fas fa-magic"></i>
      {{localize "ARCHIVIST_SYNC.worldSetup.title"}}
    </a>
    {{else}}
    <!-- Normal Mode - Show all tabs -->
    <a class="item" data-tab="world">
      <i class="fas fa-globe"></i>
      World Options
    </a>
    <a class="item" data-tab="characters">
      <i class="fas fa-users"></i>
      {{localize "ARCHIVIST_SYNC.tabs.characters"}}
    </a>
    <a class="item" data-tab="factions">
      <i class="fas fa-flag"></i>
      {{localize "ARCHIVIST_SYNC.tabs.factions"}}
    </a>
    <a class="item" data-tab="locations">
      <i class="fas fa-map-marker-alt"></i>
      {{localize "ARCHIVIST_SYNC.tabs.locations"}}
    </a>
    <a class="item" data-tab="items">
      <i class="fas fa-box"></i>
      Items
    </a>
    <a class="item" data-tab="recaps">
      <i class="fas fa-book-open"></i>
      Recaps
    </a>
    <a class="item" data-tab="config">
      <i class="fas fa-cog"></i>
      Config
    </a>

    {{/if}}

  </nav>

  <!-- Tab Content -->
  <div class="tab-content">

    {{#if showSetupMode}}
    <!-- World Setup Tab -->
    <div class="tab active" data-tab="setup">
      <div class="setup-welcome">
        <div style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; color: var(--arch-accent-pull); margin-bottom: 20px;">
            <i class="fas fa-magic"></i>
          </div>
          <h2 style="margin: 0 0 15px 0; color: var(--arch-text);">{{localize "ARCHIVIST_SYNC.worldSetup.title"}}</h2>
          <p style="color: var(--arch-text-muted); font-size: 16px; line-height: 1.5; margin-bottom: 30px;">
            {{localize "ARCHIVIST_SYNC.worldSetup.subtitle"}}
          </p>

          <div
            style="background: var(--arch-panel); border: 1px solid var(--arch-border); border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
            <h4 style="margin: 0 0 15px 0; color: var(--arch-text);">
              <i class="fas fa-globe" style="color: var(--arch-accent-pull);"></i>
              {{foundryWorldTitle}}
            </h4>
            {{#if foundryWorldDescription}}
            <p style="color: var(--arch-text-muted); margin: 0 0 15px 0;">{{foundryWorldDescription}}</p>
            {{/if}}
            <p style="color: var(--arch-text-muted); margin: 0; font-size: 14px;">
              <strong>{{localize "ARCHIVIST_SYNC.worldSetup.step1.nextSteps"}}</strong>
            </p>
            <ul style="margin: 10px 0 0 20px; color: var(--arch-text-muted); font-size: 14px;">
              <li>{{localize "ARCHIVIST_SYNC.worldSetup.step1.step1"}}</li>
              <li>{{localize "ARCHIVIST_SYNC.worldSetup.step1.step2"}}</li>
              <li>{{localize "ARCHIVIST_SYNC.worldSetup.step1.step3"}}</li>
            </ul>
          </div>

          <button type="button" data-action="openWorldSetup" class="btn"
            style="background: var(--arch-accent-pull); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
            <i class="fas fa-rocket"></i>
            Start World Setup
          </button>

          <p style="color: var(--arch-text-muted); font-size: 12px; margin-top: 20px;">
            This will guide you through connecting your Foundry world to Archivist
          </p>
        </div>
      </div>
    </div>
    {{else}}
    <!-- Normal Tabs -->
    <!-- World Options Tab -->
    <div class="tab" data-tab="world">
      <div class="form-group">
        <label>{{localize "ARCHIVIST_SYNC.labels.apiStatus"}}</label>
        <div class="api-status">
          {{#if isApiConfigured}}
          <span class="status-indicator connected">
            <i class="fas fa-check-circle"></i>
            {{localize "ARCHIVIST_SYNC.status.connected"}}
          </span>
          <small>{{localize "ARCHIVIST_SYNC.labels.apiKey"}}: {{apiKey}}</small>
          {{else}}
          <span class="status-indicator disconnected">
            <i class="fas fa-times-circle"></i>
            {{localize "ARCHIVIST_SYNC.status.notConfigured"}}
          </span>
          <small>{{localize "ARCHIVIST_SYNC.hints.configureApi"}}</small>
          {{/if}}
        </div>
      </div>

      {{#if isApiConfigured}}
      <div class="form-group">
        <button type="button" class="sync-worlds-btn" {{#if isLoading}}disabled{{/if}}>
          {{#if isLoading}}
          <i class="fas fa-spinner fa-spin"></i>
          {{localize "ARCHIVIST_SYNC.buttons.syncing"}}
          {{else}}
          <i class="fas fa-sync"></i>
          {{localize "ARCHIVIST_SYNC.buttons.syncWorlds"}}
          {{/if}}
        </button>
      </div>

      {{#if worlds.length}}
      <div class="form-group">
        <label for="world-select">{{localize "ARCHIVIST_SYNC.labels.selectWorld"}}</label>
        <select id="world-select" name="worldSelect">
          <option value="">{{localize "ARCHIVIST_SYNC.options.selectWorld"}}</option>
          {{#each worlds}}
          <option value="{{this.id}}" {{#if (eq this.id ../selectedWorldId)}}selected{{/if}}>
            {{#if this.name}}{{this.name}}{{else}}{{this.title}}{{/if}}
          </option>
          {{/each}}
        </select>
      </div>

      <div class="form-group">
        <button type="button" class="save-selection-btn" id="save-selection" disabled>
          <i class="fas fa-save"></i>
          {{localize "ARCHIVIST_SYNC.buttons.saveSelection"}}
        </button>
      </div>
      {{/if}}

      {{#if isWorldSelected}}
      <div class="current-selection">
        <h4>{{localize "ARCHIVIST_SYNC.labels.currentSelection"}}</h4>
        <p><strong>{{selectedWorldName}}</strong> (ID: {{selectedWorldId}})</p>
      </div>
      <div class="world-options">
        <div class="form-group">
          <button type="button" class="btn run-setup-wizard-btn">
            <i class="fas fa-magic"></i>
            Run World Setup Wizard
          </button>
        </div>
        <div class="form-group">
          <label for="api-key-input">API Key</label>
          <input id="api-key-input" type="password" placeholder="Enter new API key" />
          <button type="button" class="btn validate-api-key-btn">
            <i class="fas fa-key"></i>
            Validate & Save
          </button>
          <small class="api-key-hint">Validation checks the currently selected campaign.</small>
          <div class="api-key-error" style="display:none;"></div>
        </div>
      </div>
      <div class="sync-controls">
        <button type="button" class="btn pull sync-from-archivist-btn" {{#if syncInProgress}}disabled{{/if}}>
          {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-download"></i>{{/if}}
          {{localize "ARCHIVIST_SYNC.buttons.syncFromArchivist"}}
        </button>
        <button type="button" class="btn push sync-to-archivist-btn" {{#if syncInProgress}}disabled{{/if}}>
          {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-upload"></i>{{/if}}
          {{localize "ARCHIVIST_SYNC.buttons.syncFromFoundry"}}
        </button>
      </div>
      {{/if}}
      {{/if}}
    </div>

    <!-- Importer Wizard Tab (removed) -->
    {{!-- Importer removed in favor of setup flow --}}
    <div class="tab" data-tab="importer" style="display:none">
      {{#if isWorldSelected}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-file-import"></i> {{localize "ARCHIVIST_SYNC.labels.importer"}}</h4>
          <div class="actions">
            <button type="button" class="importer-create-world-btn btn" {{#if syncInProgress}}disabled{{/if}}>
              <i class="fas fa-plus"></i>
              {{localize "ARCHIVIST_SYNC.buttons.createWorld"}}
            </button>
            <button type="button" class="importer-sample-btn btn" {{#if syncInProgress}}disabled{{/if}}>
              <i class="fas fa-eye"></i>
              {{localize "ARCHIVIST_SYNC.buttons.loadData"}}
            </button>
          </div>
        </div>

        <div class="world-section">
          <div class="world-data-box importer-controls">
            <div class="input-row">
              <label>{{localize "ARCHIVIST_SYNC.labels.thresholdA"}}</label>
              <input type="number" class="import-threshold-a" step="0.05" min="0" max="1" value="{{thresholdA}}" />
            </div>
            <div class="input-row">
              <label>{{localize "ARCHIVIST_SYNC.labels.thresholdB"}}</label>
              <input type="number" class="import-threshold-b" step="0.05" min="0" max="1" value="{{thresholdB}}" />
            </div>
            <div class="input-row">
              <label>Preview</label>
              <div>
                <button type="button" class="importer-load-sample btn" {{#if syncInProgress}}disabled{{/if}}>
                  <i class="fas fa-list"></i> Sample
                </button>
                <button type="button" class="importer-load-all btn" {{#if syncInProgress}}disabled{{/if}}>
                  <i class="fas fa-list-ul"></i> All
                </button>
              </div>
            </div>
            <div class="world-field">
              <label>{{localize "ARCHIVIST_SYNC.labels.mappingOverride"}}
                <i class="fas fa-info-circle help-icon" title="{{localize 'ARCHIVIST_SYNC.help.mappingOverride'}}"></i>
              </label>
              <div>
                <textarea class="mapping-override-json"
                  style="width:100%;min-height:140px">{{mappingOverrideJson}}</textarea>
                <div style="margin-top:6px;display:flex;gap:6px">
                  <button type="button" class="mapping-load-btn btn" {{#if syncInProgress}}disabled{{/if}}><i
                      class="fas fa-upload"></i> {{localize "ARCHIVIST_SYNC.buttons.loadMapping"}}</button>
                  <button type="button" class="mapping-save-btn btn" {{#if syncInProgress}}disabled{{/if}}><i
                      class="fas fa-save"></i> {{localize "ARCHIVIST_SYNC.buttons.saveMapping"}}</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="world-section importer-preview">
          <div class="world-data-box importer-preview-body">
            <div class="importer-preview-list" style="display:grid;gap:8px">
              <div class="importer-kind-tabs" style="display:flex; gap:8px; margin-bottom:6px;">
                <button type="button" class="btn importer-kind-tab" data-kind="All">All</button>
                <button type="button" class="btn importer-kind-tab" data-kind="Actor">Actor</button>
                <button type="button" class="btn importer-kind-tab" data-kind="Journal">Journal</button>
                <button type="button" class="btn importer-kind-tab" data-kind="Scene">Scene</button>
                <button type="button" class="btn importer-kind-tab" data-kind="Item">Item</button>
              </div>
              {{#each importerGroups}}
              {{#if this.length}}
              <div class="preview-bucket" data-kind="{{@key}}">
                <h4 style="margin:0 0 6px 0; font-size:13px;">{{@key}}</h4>
                <table class="importer-preview-table" style="width:100%; border-collapse: collapse;">
                  <thead>
                    <tr>
                      <th style="text-align:left; padding:4px 6px;">Include</th>
                      <th style="text-align:left; padding:4px 6px;">Name</th>
                      <th style="text-align:left; padding:4px 6px;">Type</th>
                      <th style="text-align:left; padding:4px 6px;">Confidence</th>
                      <th style="text-align:left; padding:4px 6px;">Fields</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each this}}
                    <tr>
                      <td style="padding:4px 6px; vertical-align: top;">
                        <input type="checkbox" class="importer-include" data-uuid="{{uuid}}" {{#if
                          include}}checked{{/if}} />
                      </td>
                      <td style="padding:4px 6px; vertical-align: top; min-width:160px;">{{name}}</td>
                      <td style="padding:4px 6px; vertical-align: top;">
                        <select class="importer-type-select" data-uuid="{{uuid}}">
                          <optgroup label="Character">
                            <option value="Character:PC" {{#if (eq uiType "Character:PC" )}}selected{{/if}}>PC
                            </option>
                            <option value="Character:NPC" {{#if (eq uiType "Character:NPC" )}}selected{{/if}}>NPC
                            </option>
                          </optgroup>
                          <option value="Faction" {{#if (eq targetType "Faction" )}}selected{{/if}}>Faction</option>
                          <option value="Location" {{#if (eq targetType "Location" )}}selected{{/if}}>Location
                          </option>
                          <option value="Item" {{#if (eq targetType "Item" )}}selected{{/if}}>Item</option>
                          <option value="Note" {{#if (eq targetType "Note" )}}selected{{/if}}>Note</option>
                        </select>
                      </td>
                      <td style="padding:4px 6px; vertical-align: top;">{{score}}%</td>
                      <td style="padding:4px 6px; vertical-align: top;">
                        <div style="display:grid; gap:8px;">
                          {{#each fields}}
                          <div class="field-map-row"
                            style="display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; align-items:start;">
                            <div style="display:grid; gap:6px;">
                              <label style="font-size:12px; opacity:.8">{{key}}</label>
                              <select class="importer-field-select" data-uuid="{{../../uuid}}" data-field="{{key}}">
                                {{#each options}}
                                <option value="{{path}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                              </select>
                            </div>
                            <div
                              style="display:flex; gap:6px; align-items:flex-start; max-height: 160px; overflow:auto;">
                              <code class="field-value-chip" style="white-space: pre-wrap;">{{value}}</code>
                            </div>
                          </div>
                          {{/each}}
                        </div>
                      </td>
                    </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
              {{/if}}
              {{/each}}
              <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                <button type="button" class="importer-run-btn btn push" {{#if syncInProgress}}disabled{{/if}}>
                  {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-play"></i>{{/if}}
                  {{localize "ARCHIVIST_SYNC.buttons.runImport"}}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Deterministic Mapping Wizard Tab (removed) -->
    {{!-- Mapping Wizard removed; configuration lives in Config tab --}}
    <div class="tab" data-tab="wizard" style="display:none">
      {{#if isWorldSelected}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-wand-magic-sparkles"></i> Mapping Wizard</h4>
          <div class="actions">
            <button type="button" class="btn push deterministic-sync-btn" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-bolt"></i>{{/if}}
              Run Deterministic Sync
            </button>
          </div>
        </div>

        {{#if syncInProgress}}
        <div class="sync-progress-container">
          <div class="progress-header">
            <h5><i class="fas fa-sync-alt fa-spin"></i> Sync in Progress</h5>
            <div class="progress-stats">
              <span class="stat-item">
                <i class="fas fa-list"></i>
                <span class="stat-label">Total:</span>
                <span class="stat-value">{{syncProgress.total}}</span>
              </span>
              <span class="stat-item success">
                <i class="fas fa-check"></i>
                <span class="stat-label">Success:</span>
                <span class="stat-value">{{syncProgress.succeeded}}</span>
              </span>
              <span class="stat-item processing">
                <i class="fas fa-cog fa-spin"></i>
                <span class="stat-label">Processed:</span>
                <span class="stat-value">{{syncProgress.processed}}</span>
              </span>
              {{#if syncProgress.failed}}
              <span class="stat-item failed">
                <i class="fas fa-times"></i>
                <span class="stat-label">Failed:</span>
                <span class="stat-value">{{syncProgress.failed}}</span>
              </span>
              {{/if}}
            </div>
          </div>

          <div class="progress-bar-container">
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{syncProgress.progressPercentage}}%"></div>
            </div>
            <div class="progress-text">
              {{syncProgress.processed}} / {{syncProgress.total}} entities processed
              ({{syncProgress.progressPercentage}}%)
            </div>
          </div>

          {{#if syncProgress.currentEntity}}
          <div class="current-entity">
            <div class="entity-info">
              <strong>{{syncProgress.currentType}}:</strong> {{syncProgress.currentEntity}}
            </div>
            {{#if (eq syncProgress.phase 'retrying')}}
            <div class="retry-indicator">
              <i class="fas fa-redo"></i> Retrying failed entities...
            </div>
            {{/if}}
          </div>
          {{/if}}
        </div>
        {{/if}}

        <div class="world-section">
          <div class="world-data-box">
            <div class="input-row">
              <label>PC Description Path
                <i class="fas fa-info-circle help-icon"
                  title="Select the property path that contains PC biography/description text"></i>
              </label>
              <div class="path-selector-container">
                <select class="wizard-pc-desc path-selector"
                  style="color: var(--arch-text); background-color: var(--arch-panel);">
                  <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                    property
                    path...</option>
                  {{#each actorStringProperties}}
                  <option value="{{this.path}}" title="{{this.preview}}"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    {{this.path}} — {{this.preview}}
                  </option>
                  {{/each}}
                </select>
              </div>
            </div>
            <div class="input-row">
              <label>NPC Description Path
                <i class="fas fa-info-circle help-icon"
                  title="Select the property path that contains NPC biography/description text"></i>
              </label>
              <div class="path-selector-container">
                <select class="wizard-npc-desc path-selector"
                  style="color: var(--arch-text); background-color: var(--arch-panel);">
                  <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                    property
                    path...</option>
                  {{#each actorStringProperties}}
                  <option value="{{this.path}}" title="{{this.preview}}"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    {{this.path}} — {{this.preview}}
                  </option>
                  {{/each}}
                </select>
              </div>
            </div>
            <div class="input-row">
              <label>PC Folders
                <i class="fas fa-info-circle help-icon"
                  title="Select which Actor folders contain Player Characters to sync"></i>
              </label>
              <div class="folder-selector-container">
                {{#if actorFolders.length}}
                <div class="folder-checkboxes">
                  {{#each actorFolders}}
                  <label class="folder-checkbox">
                    <input type="checkbox" class="wizard-pc-folder-checkbox" value="{{this.name}}" />
                    <span class="folder-name" {{#if this.depth}}style="margin-left: {{this.depth}}0px;" {{/if}}>
                      {{#if this.depth}}<i class="fas fa-level-down-alt"></i>{{/if}}
                      {{this.name}}
                    </span>
                  </label>
                  {{/each}}
                </div>
                {{else}}
                <p class="no-folders">No Actor folders found. Create folders to organize your actors.</p>
                {{/if}}
              </div>
            </div>
            <div class="input-row">
              <label>NPC Folders
                <i class="fas fa-info-circle help-icon" title="Select which Actor folders contain NPCs to sync"></i>
              </label>
              <div class="folder-selector-container">
                {{#if actorFolders.length}}
                <div class="folder-checkboxes">
                  {{#each actorFolders}}
                  <label class="folder-checkbox">
                    <input type="checkbox" class="wizard-npc-folder-checkbox" value="{{this.name}}" />
                    <span class="folder-name" {{#if this.depth}}style="margin-left: {{this.depth}}0px;" {{/if}}>
                      {{#if this.depth}}<i class="fas fa-level-down-alt"></i>{{/if}}
                      {{this.name}}
                    </span>
                  </label>
                  {{/each}}
                </div>
                {{else}}
                <p class="no-folders">No Actor folders found. Create folders to organize your actors.</p>
                {{/if}}
              </div>
            </div>
            <div class="input-row">
              <label>Items: Include actor-owned from</label>
              <select class="wizard-items-owned">
                <option value="pc">PCs only</option>
                <option value="pc+npc">PCs + NPCs</option>
              </select>
            </div>
            <div class="input-row">
              <label>Items: World item folders
                <i class="fas fa-info-circle help-icon" title="Select which Item folders to include in the sync"></i>
              </label>
              <div class="folder-selector-container">
                {{#if itemFolders.length}}
                <div class="folder-checkboxes">
                  {{#each itemFolders}}
                  <label class="folder-checkbox">
                    <input type="checkbox" class="wizard-item-folder-checkbox" value="{{this.name}}" />
                    <span class="folder-name" {{#if this.depth}}style="margin-left: {{this.depth}}0px;" {{/if}}>
                      {{#if this.depth}}<i class="fas fa-level-down-alt"></i>{{/if}}
                      {{this.name}}
                    </span>
                  </label>
                  {{/each}}
                </div>
                {{else}}
                <p class="no-folders">No Item folders found. Create folders to organize your items.</p>
                {{/if}}
              </div>
            </div>
            <div class="input-row">
              <label>Factions: Journal folders
                <i class="fas fa-info-circle help-icon"
                  title="Select which Journal folders contain factions to sync"></i>
              </label>
              <div class="folder-selector-container">
                {{#if journalFolders.length}}
                <div class="folder-checkboxes">
                  {{#each journalFolders}}
                  <label class="folder-checkbox">
                    <input type="checkbox" class="wizard-faction-folder-checkbox" value="{{this.name}}" />
                    <span class="folder-name" {{#if this.depth}}style="margin-left: {{this.depth}}0px;" {{/if}}>
                      {{#if this.depth}}<i class="fas fa-level-down-alt"></i>{{/if}}
                      {{this.name}}
                    </span>
                  </label>
                  {{/each}}
                </div>
                {{else}}
                <p class="no-folders">No Journal folders found. Create folders to organize your journals.</p>
                {{/if}}
              </div>
            </div>
          </div>
        </div>

        <div class="world-section">
          <div class="world-data-box" style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="btn wizard-load-config">Load</button>
            <button type="button" class="btn push wizard-save-config">Save</button>
            <button type="button" class="btn wizard-test-paths">Test Paths</button>
          </div>
        </div>
      </div>
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Characters Tab -->
    <div class="tab" data-tab="characters">
      {{#if isWorldSelected}}
      {{#if isLoadingCharacters}}
      <div class="tab-loading-spinner">
        <i class="fas fa-spinner"></i>
        <p>Loading characters...</p>
      </div>
      {{else}}
      <div class="characters-section">
        <div class="section-header">
          <h4><i class="fas fa-users"></i> {{localize "ARCHIVIST_SYNC.labels.charactersAndNpcs"}}</h4>
          <div class="actions">
            <button type="button" class="pull-characters-btn btn pull" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-download"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pullFromArchivist"}}
            </button>
            <button type="button" class="push-characters-btn btn push" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-upload"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pushToArchivist"}}
            </button>
          </div>
        </div>
        <!-- Unified Characters List -->
        {{#if charactersRows.length}}
        <ul class="entity-list">
          {{#each charactersRows}}
          <li>
            <img class="entity-thumb" src="{{this.img}}" alt="{{this.name}}" />
            <span>
              {{this.name}}
              {{#if this.linked}}<i class="fas fa-link" title="Linked"></i>{{/if}}
            </span>
            <div class="entity-actions">
              {{#if this.canPull}}
              <button type="button" class="btn pull row-actor-pull" data-actor-id="{{this.actorId}}"
                data-archivist-id="{{this.archivistId}}" {{#if ../syncInProgress}}disabled{{/if}}>
                <i class="fas fa-download"></i>
              </button>
              {{/if}}
              {{#if this.canPush}}
              <button type="button" class="btn push row-actor-push" data-actor-id="{{this.actorId}}"
                data-archivist-id="{{this.archivistId}}" {{#if ../syncInProgress}}disabled{{/if}}>
                <i class="fas fa-upload"></i>
              </button>
              {{/if}}
            </div>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="no-actors-hint"><em>{{localize "ARCHIVIST_SYNC.messages.noActorsHint"}}</em></p>
        {{/if}}
      </div>
      {{/if}}
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Factions Tab -->
    <div class="tab" data-tab="factions">
      {{#if isWorldSelected}}
      {{#if isLoadingFactions}}
      <div class="tab-loading-spinner">
        <i class="fas fa-spinner"></i>
        <p>Loading factions...</p>
      </div>
      {{else}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-flag"></i> {{localize "ARCHIVIST_SYNC.labels.factions"}}</h4>
          <div class="actions">
            <button type="button" class="pull-factions-btn btn pull" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-download"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pullFromArchivist"}}
            </button>
            <button type="button" class="push-factions-btn btn push" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-upload"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pushToArchivist"}}
            </button>
          </div>
        </div>
        {{#if factionsRows.length}}
        <ul class="entity-list">
          {{#each factionsRows}}
          <li>
            <img class="entity-thumb" src="{{this.img}}" alt="{{this.name}}" />
            <span>
              {{this.name}}
              {{#if this.linked}}<i class="fas fa-link" title="Linked"></i>{{/if}}
            </span>
            <div class="entity-actions">
              {{#if this.canPull}}
              <button type="button" class="btn pull row-faction-pull" data-page-id="{{this.pageId}}"
                data-archivist-id="{{this.archivistId}}" {{#if ../syncInProgress}}disabled{{/if}}>
                <i class="fas fa-download"></i>
              </button>
              {{/if}}
              {{#if this.canPush}}
              <button type="button" class="btn push row-faction-push" data-page-id="{{this.pageId}}"
                data-archivist-id="{{this.archivistId}}" {{#if ../syncInProgress}}disabled{{/if}}>
                <i class="fas fa-upload"></i>
              </button>
              {{/if}}
            </div>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="no-entities">{{localize "ARCHIVIST_SYNC.messages.noFactions"}}</p>
        {{/if}}
      </div>
      {{/if}}
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Locations Tab -->
    <div class="tab" data-tab="locations">
      {{#if isWorldSelected}}
      {{#if isLoadingLocations}}
      <div class="tab-loading-spinner">
        <i class="fas fa-spinner"></i>
        <p>Loading locations...</p>
      </div>
      {{else}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-map-marker-alt"></i> {{localize "ARCHIVIST_SYNC.labels.locations"}}</h4>
          <div class="actions">
            <button type="button" class="pull-locations-btn btn pull" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-download"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pullFromArchivist"}}
            </button>
            <button type="button" class="push-locations-btn btn push" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-upload"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pushToArchivist"}}
            </button>
          </div>
        </div>
        {{#if locationsRows.length}}
        <ul class="entity-list">
          {{#each locationsRows}}
          <li>
            <img class="entity-thumb" src="{{this.img}}" alt="{{this.name}}" />
            <span>
              {{this.name}}
              {{#if this.linked}}<i class="fas fa-link" title="Linked"></i>{{/if}}
            </span>
            <div class="entity-actions">
              {{#if this.canPull}}
              <button type="button" class="btn pull row-location-pull" data-page-id="{{this.pageId}}"
                data-archivist-id="{{this.archivistId}}" {{#if ../syncInProgress}}disabled{{/if}}>
                <i class="fas fa-download"></i>
              </button>
              {{/if}}
              {{#if this.canPush}}
              <button type="button" class="btn push row-location-push" data-page-id="{{this.pageId}}"
                data-archivist-id="{{this.archivistId}}" {{#if ../syncInProgress}}disabled{{/if}}>
                <i class="fas fa-upload"></i>
              </button>
              {{/if}}
            </div>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="no-entities">{{localize "ARCHIVIST_SYNC.messages.noLocations"}}</p>
        {{/if}}
      </div>
      {{/if}}
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Items Tab -->
    <div class="tab" data-tab="items">
      {{#if isWorldSelected}}
      {{#if isLoadingItems}}
      <div class="tab-loading-spinner">
        <i class="fas fa-spinner"></i>
        <p>Loading items...</p>
      </div>
      {{else}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-box"></i> Items</h4>
          <div class="actions">
            <button type="button" class="pull-items-btn btn pull" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-download"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pullFromArchivist"}}
            </button>
            <button type="button" class="push-items-btn btn push" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-upload"></i>{{/if}}
              {{localize "ARCHIVIST_SYNC.buttons.pushToArchivist"}}
            </button>
          </div>
        </div>
        {{#if itemsRows.length}}
        <ul class="entity-list">
          {{#each itemsRows}}
          <li>
            <img class="entity-thumb" src="{{this.img}}" alt="{{this.name}}" />
            <span>
              {{this.name}}
              {{#if this.linked}}<i class="fas fa-link" title="Linked"></i>{{/if}}
            </span>
            <div class="entity-actions">
              {{#if this.canPull}}
              <button type="button" class="btn pull row-item-pull" data-archivist-id="{{this.archivistId}}">
                <i class="fas fa-download"></i>
              </button>
              {{/if}}
              {{#if this.canPush}}
              <button type="button" class="btn push row-item-push" data-item-id="{{this.itemId}}">
                <i class="fas fa-upload"></i>
              </button>
              {{/if}}
            </div>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="no-entities">No items found.</p>
        {{/if}}
      </div>
      {{/if}}
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Recaps Tab -->
    <div class="tab" data-tab="recaps">
      {{#if isWorldSelected}}
      {{#if isLoadingRecaps}}
      <div class="tab-loading-spinner">
        <i class="fas fa-spinner"></i>
        <p>Loading recaps...</p>
      </div>
      {{else}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-book-open"></i> Recaps</h4>
          <div class="actions">
            <button type="button" class="pull-recaps-btn btn pull" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-download"></i>{{/if}}
              Pull from Archivist
            </button>
            <button type="button" class="push-recaps-btn btn push" {{#if syncInProgress}}disabled{{/if}}>
              {{#if syncInProgress}}<i class="fas fa-spinner fa-spin"></i>{{else}}<i class="fas fa-upload"></i>{{/if}}
              Push to Archivist
            </button>
          </div>
        </div>
        {{#if recapsRows.length}}
        <ul class="entity-list">
          {{#each recapsRows}}
          <li>
            {{#if this.img}}
            <img class="entity-thumb" src="{{this.img}}" alt="{{this.name}}" />
            {{else}}
            <i class="fas fa-book-open entity-thumb"
              style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;"></i>
            {{/if}}
            <span>
              {{this.name}}
              {{#if this.linked}}<i class="fas fa-link" title="Linked"></i>{{/if}}
            </span>
            <div class="entity-actions">
              {{#if this.canPull}}
              <button type="button" class="btn pull row-recap-pull" data-session-id="{{this.sessionId}}">
                <i class="fas fa-download"></i>
              </button>
              {{/if}}
              {{#if this.canPush}}
              <button type="button" class="btn push row-recap-push" data-page-id="{{this.pageId}}">
                <i class="fas fa-upload"></i>
              </button>
              {{/if}}
            </div>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="no-entities">No recaps found.</p>
        {{/if}}
      </div>
      {{/if}}
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>

    <!-- Config Tab -->
    <div class="tab" data-tab="config">
      {{#if isWorldSelected}}
      <div class="entities-section">
        <div class="section-header">
          <h4><i class="fas fa-cog"></i> Configuration Settings</h4>
          <div class="actions">
            <button type="button" class="btn" data-action="downloadSampleConfig">
              <i class="fas fa-download"></i>
              Download Sample
            </button>
            <button type="button" class="btn" data-action="loadConfig">
              <i class="fas fa-upload"></i>
              Load Config
            </button>
            <button type="button" class="btn push" data-action="saveConfig">
              <i class="fas fa-save"></i>
              Save Config
            </button>
          </div>
        </div>

        <div class="world-section">
          <div class="world-data-box">
            <!-- System Presets -->
            <div class="input-row">
              <label>System Preset
                <i class="fas fa-info-circle help-icon"
                  title="Select a preset configuration for common game systems"></i>
              </label>
              <div class="path-selector-container">
                <select class="cfg-system-preset" style="color: var(--arch-text); background-color: var(--arch-panel);">
                  <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Custom
                    Configuration</option>
                  <option value="dnd5e" selected style="color: var(--arch-text); background-color: var(--arch-panel);">
                    D&D
                    5e</option>
                  <option value="pf2e" style="color: var(--arch-text); background-color: var(--arch-panel);">Pathfinder
                    2e
                  </option>
                  <option value="coc7" style="color: var(--arch-text); background-color: var(--arch-panel);">Call of
                    Cthulhu 7e</option>
                </select>
              </div>
            </div>

            <!-- PC Configuration -->
            <div class="manual-mapping-section">
              <h5
                style="margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid var(--arch-border); color: var(--arch-text);">
                <i class="fas fa-user"></i> Player Character Mapping
              </h5>
              <div class="input-row">
                <label>PC Name Path
                  <i class="fas fa-info-circle help-icon" title="Select the property path that contains PC name"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-pc-name path-selector"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                      property
                      path...</option>
                    {{#each actorStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}"
                      style="color: var(--arch-text); background-color: var(--arch-panel);">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="input-row">
                <label>PC Image Path
                  <i class="fas fa-info-circle help-icon"
                    title="Select the property path that contains PC image/avatar"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-pc-img path-selector"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                      property
                      path...</option>
                    {{#each actorStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}"
                      style="color: var(--arch-text); background-color: var(--arch-panel);">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="input-row">
                <label>PC Description Path
                  <i class="fas fa-info-circle help-icon"
                    title="Select the property path that contains PC biography/description text"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-pc-desc path-selector"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                      property
                      path...</option>
                    {{#each actorStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}"
                      style="color: var(--arch-text); background-color: var(--arch-panel);">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>

              <!-- NPC Configuration -->
              <h5
                style="margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid var(--arch-border); color: var(--arch-text);">
                <i class="fas fa-users"></i> Non-Player Character Mapping
              </h5>
              <div class="input-row">
                <label>NPC Name Path
                  <i class="fas fa-info-circle help-icon" title="Select the property path that contains NPC name"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-npc-name path-selector"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                      property
                      path...</option>
                    {{#each actorStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}"
                      style="color: var(--arch-text); background-color: var(--arch-panel);">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="input-row">
                <label>NPC Image Path
                  <i class="fas fa-info-circle help-icon"
                    title="Select the property path that contains NPC image/avatar"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-npc-img path-selector"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                      property
                      path...</option>
                    {{#each actorStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}"
                      style="color: var(--arch-text); background-color: var(--arch-panel);">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="input-row">
                <label>NPC Description Path
                  <i class="fas fa-info-circle help-icon"
                    title="Select the property path that contains NPC biography/description text"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-npc-desc path-selector"
                    style="color: var(--arch-text); background-color: var(--arch-panel);">
                    <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Select a
                      property
                      path...</option>
                    {{#each actorStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}"
                      style="color: var(--arch-text); background-color: var(--arch-panel);">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>

              <!-- Item Configuration -->
              <h5
                style="margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid var(--arch-border); color: var(--arch-text);">
                <i class="fas fa-box"></i> Item Mapping
              </h5>
              <div class="input-row">
                <label>Item Name Path
                  <i class="fas fa-info-circle help-icon" title="Select the property path that contains Item name"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-item-name path-selector">
                    <option value="">Select a property path...</option>
                    {{#each itemStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="input-row">
                <label>Item Image Path
                  <i class="fas fa-info-circle help-icon"
                    title="Select the property path that contains Item image/icon"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-item-img path-selector">
                    <option value="">Select a property path...</option>
                    {{#each itemStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="input-row">
                <label>Item Description Path
                  <i class="fas fa-info-circle help-icon"
                    title="Select the property path that contains Item description text"></i>
                </label>
                <div class="path-selector-container">
                  <select class="cfg-item-desc path-selector">
                    <option value="">Select a property path...</option>
                    {{#each itemStringProperties}}
                    <option value="{{this.path}}" title="{{this.preview}}">
                      {{this.path}} — {{this.preview}}
                    </option>
                    {{/each}}
                  </select>
                </div>
              </div>
            </div> <!-- End manual-mapping-section -->

            <!-- Destination Configuration -->
            <h5
              style="margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid var(--arch-border); color: var(--arch-text);">
              <i class="fas fa-arrow-right"></i> Sync Destinations
            </h5>
            <div class="input-row">
              <label>PC Destination
                <i class="fas fa-info-circle help-icon" title="Where to sync Player Characters"></i>
              </label>
              <select class="cfg-dest-pc" style="color: var(--arch-text); background-color: var(--arch-panel);">
                <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Root (Default)
                </option>
                {{#each actorFolders}}
                <option value="{{this.id}}" style="color: var(--arch-text); background-color: var(--arch-panel);">
                  {{this.name}}</option>
                {{/each}}
              </select>
            </div>
            <div class="input-row">
              <label>NPC Destination
                <i class="fas fa-info-circle help-icon" title="Where to sync Non-Player Characters"></i>
              </label>
              <select class="cfg-dest-npc" style="color: var(--arch-text); background-color: var(--arch-panel);">
                <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Root (Default)
                </option>
                {{#each actorFolders}}
                <option value="{{this.id}}" style="color: var(--arch-text); background-color: var(--arch-panel);">
                  {{this.name}}</option>
                {{/each}}
              </select>
            </div>
            <div class="input-row">
              <label>Item Destination
                <i class="fas fa-info-circle help-icon" title="Where to sync Items"></i>
              </label>
              <select class="cfg-dest-item" style="color: var(--arch-text); background-color: var(--arch-panel);">
                <option value="" style="color: var(--arch-text); background-color: var(--arch-panel);">Root (Default)
                </option>
                {{#each itemFolders}}
                <option value="{{this.id}}" style="color: var(--arch-text); background-color: var(--arch-panel);">
                  {{this.name}}</option>
                {{/each}}
              </select>
            </div>
          </div>
        </div>
      </div>
      {{else}}
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{localize "ARCHIVIST_SYNC.warnings.selectWorldFirst"}}</p>
      </div>
      {{/if}}
    </div>
    {{/if}}

  </div>
</form>